# This is a ZoneMinder PKGBUILD file. 
# Contributor: Ross melin <rdmelin@gmail.com>

pkgname=zoneminder
pkgver=1.24.2
pkgrel=2
pkgdesc="Capture, analyse, record and monitor video security cameras."
arch=('i686')
url="http://www.zoneminder.com"
license=('GPL')
groups=()
depends=('apache' 'php' 'mysql' 'pcre' 'openssl' 'ffmpeg-svn>=18940' 'perl-php-serialization' 'perl-libwww' 'perl-date-manip' 'perl-unicode-map' 'perl-dbi' 'perl-dbd-mysql' 'perl-io-stringy' 'perl-mime-lite' 'perl-timedate' 'perl-x10' 'perl-time-modules' 'perl-net-smtp-ssl' 'perl-sys-mmap' 'sudo' 'libv4l')
makedepends=()
provides=(zoneminder)
conflicts=(zoneminder)
replaces=()
backup=()
options=()
install=zoneminder.install
source=(http://www2.zoneminder.com/downloads/ZoneMinder-1.24.2.tar.gz \
	zm.rc.d \
 	zm.conf.patch \
  zmupdate.patch \
  Controls_Orbit.sql \
  Makefile.patch \
  zm_libv4l.patch \
 	zminit.arch \
  customdb \
  httpd-zm.conf \
  zmfilter.pl \
  http://superb-west.dl.sourceforge.net/sourceforge/jscalendar/jscalendar-1.0.zip \
  http://www.charliemouse.com:8080/code/cambozola/cambozola-0.50.tar.gz \
  zmeventbackup)
noextract=()
md5sums=()
build() {
	cd "$srcdir/ZoneMinder-$pkgver"

	patch -p1 < $srcdir/zm.conf.patch || read
  patch -p1 < $srcdir/zmupdate.patch || read
  patch -p1 -b < $srcdir/zm_libv4l.patch || read
  cat ../Controls_Orbit.sql >> db/zm_create.sql.in
  sed -i '22s/^$/#include <cstdio>/' \
  src/zm_utils.cpp
  sed -i 's/$max_socket_tries = 3;/$max_socket_tries = 15;/' \
  web/ajax/stream.php || read

	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--with-webuser=http  \
		--with-webgroup=http \
		--with-mysql=/usr  \
		--with-webdir=/var/lib/zm/www  \
    --with-cgidir=/var/lib/zm/cgi-bin \
    --with-extralibs="-lv4l1 -lv4l2" \
    --bindir=/usr/lib/zm/bin \
    --enable-mmap=no \
    ZM_SSL_LIB=openssl

  patch -p1 < $srcdir/Makefile.patch ||read
	make || return 1
	make DESTDIR="$pkgdir" install || return 1

	install -D -m 700 $startdir/src/zminit.arch  $startdir/pkg/usr/lib/zm/bin/zminit
	install -D -m 700 $startdir/src/zm.rc.d  $startdir/pkg/etc/rc.d/zm
  install -D -m 700 scripts/zmdbbackup  $startdir/pkg/usr/lib/zm/bin/zmdbbackup
  install -D -m 700 scripts/zmdbbackup  $startdir/pkg/usr/lib/zm/bin/zmdbbackup
  install -D -m 700 scripts/zmdbrestore  $startdir/pkg/usr/lib/zm/bin/zmdbrestore
  install -D -m 700 scripts/zmeventdump  $startdir/pkg/usr/lib/zm/bin/zmeventdump
  install -D -m 700 scripts/zmlogrotate.conf  $startdir/pkg/etc/logrotate.d/zm
  install -D -m 700 $startdir/src/zmeventbackup  $startdir/pkg/etc/cron.hourly/zmeventbackup
  install -D -m 755 $startdir/src/zmfilter.pl $startdir/pkg/usr/lib/zm/bin/zmfilter.pl

  tar -zxf $startdir/src/cambozola-0.50.tar.gz 
  install -m 644  cambozola-0.50/dist/cambozola.jar $startdir/pkg/var/lib/zm/www/cambozola.jar
  
  mkdir -p  $startdir/pkg/etc/httpd/conf/extra/
  install -m 644 $startdir/src/httpd-zm.conf $startdir/pkg/etc/httpd/conf/extra/httpd-zm.conf
  
  unzip  $startdir/src/jscalendar-1.0.zip
  mv $startdir/src/jscalendar-1.0 $startdir/pkg/var/lib/zm/www/tools/jscalendar

  install -D -m 700 $startdir/src/customdb $startdir/pkg/usr/lib/zm/upgrade/customdb
	install -D  db/zm*.sql $startdir/pkg/usr/lib/zm/upgrade/

  mkdir -p $startdir/pkg/var/run/zm

  ### remove special files
  find $startdir/pkg/ -name "perllocal.pod" \
    -o -name ".packlist"                \
    -o -name "*.bs"                     \
    |xargs -i rm -f {}

}

# vim:set ts=2 sw=2 et:
